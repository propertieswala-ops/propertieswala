<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Property Details | PropertiesWala</title>
  <meta name="description" content="Property details page for verified listings across West Bengal." />

  <link rel="stylesheet" href="style.css"/>
</head>

<body>

  <header class="navbar">
    <div class="logo">Properties<span>Wala</span></div>
    <nav>
      <a href="index.html#home">Home</a>
      <a href="index.html#properties">Properties</a>
      <a href="index.html#contact">Contact</a>
    </nav>
  </header>

  <section class="properties" style="padding-top: 30px;">
    <h2>Property Details</h2>
    <div id="detailsBox" style="max-width: 900px; margin: 20px auto; text-align:left;"></div>
  </section>

  <footer class="footer">
    <p>Â© 2026 PropertiesWala. All rights reserved.</p>
  </footer>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRgoZIBoAGvAYPO4Nz2se3QJ8aWENUUfYtLW7l25i3B0EkVzYzhgrtupPOIbPXuJ8N_wKf_E9ckipxv/pub?output=csv";
    const DEFAULT_WHATSAPP = "919433365152";
    const IMAGE_FOLDER = "image";

    function cleanValue(v) {
      return (v || "").toString().trim();
    }

    function parseCSV(csvText) {
      const rows = [];
      let row = [];
      let current = "";
      let insideQuotes = false;

      for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        const next = csvText[i + 1];

        if (char === '"' && insideQuotes && next === '"') {
          current += '"';
          i++;
        } else if (char === '"') {
          insideQuotes = !insideQuotes;
        } else if (char === "," && !insideQuotes) {
          row.push(current);
          current = "";
        } else if (char === "\n" && !insideQuotes) {
          row.push(current);
          rows.push(row);
          row = [];
          current = "";
        } else {
          current += char;
        }
      }

      if (current.length > 0 || row.length > 0) {
        row.push(current);
        rows.push(row);
      }

      return rows;
    }

    function buildImageURL(imageValue) {
      const img = cleanValue(imageValue);

      if (img.startsWith("http://") || img.startsWith("https://")) return img;

      if (img.startsWith("image/")) return "/" + img;

      return `/${IMAGE_FOLDER}/${img}`;
    }

    function buildWhatsAppLink(phone, message) {
      const wa = cleanValue(phone) || DEFAULT_WHATSAPP;
      return `https://wa.me/${wa}?text=${encodeURIComponent(message)}`;
    }

    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    async function loadPropertyDetails() {
      const propId = getQueryParam("id");
      const box = document.getElementById("detailsBox");

      if (!propId) {
        box.innerHTML = "<p>No property ID found.</p>";
        return;
      }

      try {
        const res = await fetch(CSV_URL);
        const text = await res.text();

        const rows = parseCSV(text.trim());
        const headers = rows[0].map(h => cleanValue(h));

        const list = rows.slice(1).map(cols => {
          const obj = {};
          headers.forEach((h, i) => {
            obj[h] = cleanValue(cols[i] || "");
          });
          return obj;
        });

        const p = list.find(x => cleanValue(x.ID) === cleanValue(propId));

        if (!p) {
          box.innerHTML = "<p>Property not found.</p>";
          return;
        }

        const imgUrl = buildImageURL(p.Image);
        const waMsg =
`Hi PropertiesWala, I am interested in Property ID: ${p.ID}.
Type: ${p.Type}
Location: ${p.Location}
Please share full details and arrange a visit.`;

        box.innerHTML = `
          <div class="property-card" style="overflow:hidden;">
            <img src="${imgUrl}" alt="${p.Type} in ${p.Location}" style="height:320px;" />
            <div class="property-info">
              <h3>${p.Type}</h3>
              <p><strong>Property ID:</strong> ${p.ID}</p>
              <p><strong>Category:</strong> ${p.Category}</p>
              <p><strong>Location:</strong> ${p.Location}</p>
              <p><strong>Area:</strong> ${p.Area} sqft</p>
              <p><strong>Price:</strong> ${p.Price}</p>

              <div class="card-actions" style="max-width:380px;">
                <a class="btn btn-green" target="_blank" href="${buildWhatsAppLink(p.WhatsApp, waMsg)}">WhatsApp Enquiry</a>
                <a class="btn btn-blue" href="tel:+91${cleanValue(p.WhatsApp) || DEFAULT_WHATSAPP}">Call Now</a>
                <a class="btn btn-outline" href="index.html#properties">Back to Properties</a>
              </div>
            </div>
          </div>
        `;
      } catch (err) {
        box.innerHTML = "<p>Error loading property details.</p>";
        console.error(err);
      }
    }

    loadPropertyDetails();
  </script>

</body>
</html>
